# Claude Code Cluster PoC - 実行例とユースケース

## 📚 目次

1. [基本的な実行例](#基本的な実行例)
2. [専門Agent別実行例](#専門agent別実行例)
3. [分散処理実行例](#分散処理実行例)
4. [実際のユースケース](#実際のユースケース)
5. [エラー対応例](#エラー対応例)

## 🚀 基本的な実行例

### 例1: シンプルなバグ修正

**前提:**
- GitHub Issue #42: "ログイン画面でパスワードが見えてしまう"
- リポジトリ: `mycompany/web-app`

```bash
# ローカルで実行
claude-cluster workflow --issue 42 --repo mycompany/web-app
```

**実行ログ例:**
```
📝 Creating task from issue #42 in mycompany/web-app
⚡ Analyzing issue requirements...
🎯 Selected FrontendAgent (confidence: 0.85)
🔧 Generating implementation...
✅ Created pull request: https://github.com/mycompany/web-app/pull/123

Task completed successfully!
🎯 Used specialized agent: FrontendAgent
📋 Pull request created: https://github.com/mycompany/web-app/pull/123
```

**生成されるPR内容例:**
```markdown
## Summary
Fix password visibility issue in login form by adding proper type attribute

## Specialized Agent
This implementation was generated by **FrontendAgent** with the following specialties:
- frontend, ui, react, javascript, typescript

## Changes Made
- src/components/LoginForm.tsx: Added type="password" to password input
- src/components/LoginForm.test.tsx: Added test for password input type

## Testing Strategy
- Component rendering tests
- User interaction tests
- Input field validation tests
- Password masking verification tests

## Review Criteria
- Components are reusable and well-structured
- TypeScript types are properly defined
- Accessibility guidelines are followed
- Code is responsive and mobile-friendly
```

### 例2: API エンドポイント追加

**前提:**
- GitHub Issue #156: "ユーザープロフィール取得APIエンドポイントの追加"
- リポジトリ: `mycompany/api-server`

```bash
# 詳細な実行過程を確認
claude-cluster create-task --issue 156 --repo mycompany/api-server
# → task-20241208-001

claude-cluster run-task task-20241208-001

# 実行状況確認
claude-cluster status --task-id task-20241208-001
```

**期待される選択プロセス:**
```
🔍 Analyzing task requirements...

Agent Scoring Results:
- BackendAgent: 0.92 (backend, api, database keywords detected)
- FrontendAgent: 0.15 (minimal frontend relevance)
- TestingAgent: 0.25 (testing mentioned in requirements)
- DevOpsAgent: 0.10 (minimal infrastructure relevance)

✅ Selected: BackendAgent (highest confidence)

🛠️ Task Analysis:
- needs_database: true
- needs_api: true
- needs_authentication: true
- complexity_factors: ['database_operations', 'api_design', 'authentication']
```

**生成されるファイル例:**
```
src/
├── models/
│   └── user_profile.py          # Pydantic models
├── routers/
│   └── user_profiles.py         # FastAPI router
├── services/
│   └── user_profile_service.py  # Business logic
└── tests/
    └── test_user_profiles.py    # pytest tests
```

## 🎯 専門Agent別実行例

### BackendAgent実行例

**Issue例:** "PostgreSQL接続プールの最適化"

```bash
claude-cluster workflow --issue 78 --repo company/backend-service
```

**BackendAgentが生成する内容:**
- SQLAlchemy設定の最適化
- 接続プール設定の追加
- ヘルスチェックエンドポイント
- 監視メトリクス追加
- pytest統合テスト

**生成ファイル:**
```python
# src/database/connection.py
from sqlalchemy import create_engine
from sqlalchemy.pool import QueuePool

def create_optimized_engine(database_url: str):
    return create_engine(
        database_url,
        poolclass=QueuePool,
        pool_size=10,
        max_overflow=20,
        pool_pre_ping=True,
        pool_recycle=3600
    )

# src/api/health.py
@router.get("/health/database")
async def database_health():
    try:
        # Connection pool health check
        with engine.connect() as conn:
            conn.execute(text("SELECT 1"))
        return {"status": "healthy", "pool_size": engine.pool.size()}
    except Exception as e:
        raise HTTPException(status_code=503, detail=str(e))
```

### FrontendAgent実行例

**Issue例:** "ダッシュボードの新しいウィジェット追加"

```bash
claude-cluster workflow --issue 91 --repo company/dashboard-app
```

**FrontendAgentが生成する内容:**
- React コンポーネント（TypeScript）
- CSS Modules または styled-components
- Jest + React Testing Library テスト
- Storybook stories（もし検出されれば）

**生成ファイル:**
```tsx
// src/components/Dashboard/MetricsWidget.tsx
interface MetricsWidgetProps {
  title: string;
  value: number;
  trend: 'up' | 'down' | 'neutral';
  loading?: boolean;
}

export const MetricsWidget: React.FC<MetricsWidgetProps> = ({
  title,
  value,
  trend,
  loading = false
}) => {
  return (
    <div className="metrics-widget" data-testid="metrics-widget">
      <h3>{title}</h3>
      {loading ? (
        <div className="loading-spinner" />
      ) : (
        <div className="metrics-content">
          <span className="value">{value.toLocaleString()}</span>
          <span className={`trend trend--${trend}`}>
            {trend === 'up' ? '↑' : trend === 'down' ? '↓' : '→'}
          </span>
        </div>
      )}
    </div>
  );
};

// src/components/Dashboard/MetricsWidget.test.tsx
describe('MetricsWidget', () => {
  it('renders with correct value', () => {
    render(
      <MetricsWidget 
        title="Active Users" 
        value={1234} 
        trend="up" 
      />
    );
    
    expect(screen.getByText('Active Users')).toBeInTheDocument();
    expect(screen.getByText('1,234')).toBeInTheDocument();
    expect(screen.getByText('↑')).toBeInTheDocument();
  });
});
```

### TestingAgent実行例

**Issue例:** "E2Eテストカバレッジの改善"

```bash
claude-cluster workflow --issue 203 --repo company/e-commerce-site
```

**TestingAgentが生成する内容:**
- Cypressまたは Playwright E2Eテスト
- テストデータファクトリー
- CI/CD統合設定

**生成ファイル:**
```typescript
// cypress/e2e/checkout-flow.cy.ts
describe('Checkout Flow', () => {
  beforeEach(() => {
    cy.login('test@example.com', 'password123');
    cy.addItemToCart('product-1');
  });

  it('completes purchase successfully', () => {
    cy.visit('/cart');
    cy.get('[data-testid="checkout-btn"]').click();
    
    // Fill shipping information
    cy.fillShippingForm({
      firstName: 'John',
      lastName: 'Doe',
      address: '123 Main St',
      city: 'Anytown',
      postalCode: '12345'
    });
    
    // Select payment method
    cy.selectPaymentMethod('credit-card');
    cy.fillCreditCardForm({
      number: '4111111111111111',
      expiry: '12/25',
      cvv: '123'
    });
    
    // Complete purchase
    cy.get('[data-testid="place-order-btn"]').click();
    cy.url().should('include', '/order-confirmation');
    cy.get('[data-testid="order-number"]').should('be.visible');
  });
});
```

### DevOpsAgent実行例

**Issue例:** "Docker化とCI/CDパイプライン構築"

```bash
claude-cluster workflow --issue 45 --repo company/microservice
```

**DevOpsAgentが生成する内容:**
- Multi-stage Dockerfile
- GitHub Actions workflow
- docker-compose.yml
- Kubernetes manifests（プロジェクトサイズによる）

**生成ファイル:**
```dockerfile
# Dockerfile
FROM node:18-alpine as builder

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

FROM node:18-alpine as runtime

RUN addgroup -g 1001 -S nodejs
RUN adduser -S nextjs -u 1001

WORKDIR /app
COPY --from=builder /app/node_modules ./node_modules
COPY --chown=nextjs:nodejs . .

USER nextjs
EXPOSE 3000
ENV PORT 3000

CMD ["npm", "start"]
```

```yaml
# .github/workflows/ci.yml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: npm test
    
    - name: Run linting
      run: npm run lint

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Build Docker image
      run: docker build -t ${{ github.repository }}:latest .
    
    - name: Deploy to staging
      run: |
        echo "Deploying to staging environment"
        # Add actual deployment commands here
```

## 🌐 分散処理実行例

### 複数Agentでの並行処理

**シナリオ:** 大規模なフィーチャー開発
- Issue #500: "ユーザー管理システムの完全リニューアル"

```bash
# 分散クラスターで実行
claude-cluster-distributed workflow \
  --issue 500 \
  --repo company/user-management \
  --distributed \
  --coordinator-host 192.168.1.10
```

**処理の流れ:**

1. **タスク分析** (Coordinator)
```
📊 Task Analysis Results:
- Detected requirements: backend, frontend, testing, devops
- Complexity: high
- Estimated subtasks: 4
- Priority: high
```

2. **Agent割り当て** (Load Balancer)
```
🎯 Agent Assignment:
- backend-node-001 (192.168.1.11): Backend API development
- frontend-node-001 (192.168.1.12): UI components
- testing-node-001 (192.168.1.13): Test suite creation  
- devops-node-001 (192.168.1.14): Infrastructure updates
```

3. **並行実行**
```
🔄 Parallel Execution:
[Backend ] 🔧 Generating user API endpoints...
[Frontend] 🎨 Creating user management UI...
[Testing ] 🧪 Writing integration tests...
[DevOps  ] 🐳 Updating deployment configs...
```

4. **結果統合**
```
✅ All agents completed successfully!
📋 Created unified pull request with:
- 15 backend files (API, models, services)
- 8 frontend components 
- 12 test files (unit + integration)
- 3 infrastructure files (Docker, CI/CD)
```

### 負荷分散の実例

**クラスター状態:**
```bash
curl http://192.168.1.10:8001/api/cluster/status
```

**応答例:**
```json
{
  "nodes": {
    "total": 4,
    "online": 4,
    "offline": 0
  },
  "tasks": {
    "total": 12,
    "pending": 2,
    "active": 4,
    "completed": 6
  },
  "node_details": [
    {
      "node_id": "backend-node-001",
      "status": "online",
      "current_tasks": ["task-001", "task-005"],
      "max_concurrent_tasks": 2,
      "specialties": ["backend", "api", "database"]
    },
    {
      "node_id": "frontend-node-001", 
      "status": "online",
      "current_tasks": ["task-003"],
      "max_concurrent_tasks": 2,
      "specialties": ["frontend", "react", "ui"]
    },
    {
      "node_id": "testing-node-001",
      "status": "online", 
      "current_tasks": ["task-007"],
      "max_concurrent_tasks": 3,
      "specialties": ["testing", "qa", "pytest"]
    }
  ]
}
```

## 📋 実際のユースケース

### ユースケース1: スタートアップでの活用

**状況:**
- 5人のエンジニアチーム
- 毎日10-20個のGitHub Issue
- バックログ処理の自動化が必要

**構成:**
```bash
# Docker Compose で簡単クラスター
docker-compose up -d

# Webhook設定でGitHub連携
# GitHub Repository Settings > Webhooks > Add webhook
# Payload URL: http://your-server.com:8000/webhook/github
# Content type: application/json
# Events: Issues, Pull requests
```

**効果:**
- 簡単なバグ修正: 手動30分 → 自動5分
- 新機能の初期実装: 手動2-3時間 → 自動30分-1時間  
- テストコード作成: 手動1時間 → 自動15分

### ユースケース2: 大企業での概念実証

**状況:**
- 複数チーム（50+エンジニア）
- 厳格なコードレビュープロセス
- セキュリティ要件が厳しい

**構成:**
```bash
# 分散クラスター（セキュアネットワーク内）
# Coordinator: 1台（高可用性）
# Agent nodes: 10台（チーム別）

# プライベートネットワーク内での展開
claude-cluster-distributed start-coordinator --host 10.0.1.100
claude-cluster-distributed start-node --coordinator-host 10.0.1.100 --specialties backend
claude-cluster-distributed start-node --coordinator-host 10.0.1.100 --specialties frontend
# ... 他のノード
```

**カスタマイズ:**
- 企業コーディング標準の組み込み
- セキュリティスキャンの統合
- 社内ライブラリの優先使用

### ユースケース3: オープンソースプロジェクト

**状況:**
- GitHub上のOSSプロジェクト
- 貢献者が世界中に分散
- メンテナンス負荷軽減が目標

**構成:**
```bash
# GitHub Actions との統合
# .github/workflows/claude-cluster.yml

name: Claude Cluster Auto-Implementation
on:
  issues:
    types: [labeled]

jobs:
  auto-implement:
    if: contains(github.event.label.name, 'auto-implement')
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Setup Claude Cluster
      run: |
        pip install claude-code-cluster-poc
        claude-cluster setup
    - name: Process Issue
      run: |
        claude-cluster workflow \
          --issue ${{ github.event.issue.number }} \
          --repo ${{ github.repository }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
```

## ⚠️ エラー対応例

### よくあるエラーと対処法

#### 1. Agent選択エラー

**エラー:**
```
❌ No suitable agent found for task
Agent scores: BackendAgent: 0.12, FrontendAgent: 0.08, TestingAgent: 0.15, DevOpsAgent: 0.05
All scores below confidence threshold (0.3)
```

**原因:** Issue の内容が曖昧で、どのAgentも十分な信頼度を持てない

**対処法:**
```bash
# より明確なIssue説明を作成するか、手動でAgentを指定
claude-cluster create-task --issue 123 --repo owner/repo
# → Issue #123 を編集して技術的詳細を追加

# または強制的に特定のAgentを使用
claude-cluster run-task task-123 --force-agent backend
```

#### 2. 分散処理での接続エラー

**エラー:**
```
❌ Failed to connect to coordinator at 192.168.1.10:8001
Connection refused
```

**デバッグ手順:**
```bash
# 1. Coordinatorの状態確認
ssh ubuntu@192.168.1.10
sudo systemctl status claude-coordinator

# 2. ファイアウォール確認
sudo ufw status
# Port 8001が開いているか確認

# 3. ネットワーク接続テスト
telnet 192.168.1.10 8001

# 4. サービス再起動
sudo systemctl restart claude-coordinator
```

#### 3. Claude API制限エラー

**エラー:**
```
❌ Anthropic API rate limit exceeded
Rate limit: 100 requests per minute
```

**対処法:**
```bash
# 1. APIキーの使用量確認
curl -H "Authorization: Bearer $ANTHROPIC_API_KEY" \
     https://api.anthropic.com/v1/usage

# 2. リクエスト頻度を下げる
export CLAUDE_REQUEST_DELAY=30  # 30秒間隔

# 3. より軽量なモデルを使用
# agents の設定で claude-3-haiku-20240307 を優先
```

#### 4. GitHub PR作成失敗

**エラー:**
```
❌ Failed to create pull request: Repository not found or access denied
```

**確認事項:**
```bash
# 1. GitHub token の権限確認
curl -H "Authorization: token $GITHUB_TOKEN" \
     https://api.github.com/user

# 2. リポジトリアクセス権確認  
curl -H "Authorization: token $GITHUB_TOKEN" \
     https://api.github.com/repos/owner/repo

# 3. ブランチ作成権限確認
# Personal Access Token の scope に 'repo' が含まれているか確認
```

### デバッグ用コマンド

```bash
# 詳細ログ出力
export LOG_LEVEL=DEBUG
claude-cluster-distributed status --show-cluster

# 特定タスクの詳細情報
claude-cluster status --task-id task-123 --verbose

# Agent性能テスト
claude-cluster agents --test-mode

# ネットワーク診断
claude-cluster-distributed diagnose --coordinator-host 192.168.1.10
```

---

**注意:** これらの例は参考用です。実際の実行結果は、Issueの内容、リポジトリの構成、使用するClaude モデルによって異なります。